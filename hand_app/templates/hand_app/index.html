<!DOCTYPE html>
<html>
<head>
  {% load static %}
    <link
      rel="stylesheet"
      href="{% static 'css/bootstrap.min.css' %}"
      type="text/css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
  <title>Hand Gesture Video Control</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #f4f7fa;
      margin: 0;
      padding: 20px;
      text-align: center;
    }

    h2 {
      color: #333;
      font-size: 24px;
      margin-bottom: 20px;
    }

    .container {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
      align-items: center;
    }

    .video-container {
      width: 40%;
      position: relative;
      max-width: 640px;
    }

    #video {
      display: none;
      width: 100%;
      height: auto;
      border-radius: 8px;
      background-color: #000;
      position: absolute;
      top: 0;
      left: 0;
      cursor: move;
    }

    .controls {
      margin-top: 20px;
      text-align: center;
    }

    button {
      padding: 12px 20px;
      font-size: 16px;
      margin: 10px;
      border-radius: 5px;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    #startCam {
      background-color: #28a745;
      color: white;
      transition: all ease .3s;
    }

    #startCam:hover {
      background-color:#28a746;
      color: white;
    }

    #stopCam {
      background-color: #dc3545;
      color: white;
    }

    #fileInput {
      background-color: #007bff;
      color: white;
    }

    button:hover {
      background-color: #0056b3;
    }

    .status {
      font-size: 18px;
      color: #555;
      margin-top: 20px;
    }

    .video-player-container {
      width: 40%;
      max-width: 640px;
    }

    .camera-container {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 20px;
    }

    .file-input {
      display: none;
    }

    .custom-file-upload {
      cursor: pointer;
      display: inline-block;
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      border-radius: 5px;
      text-align: center;
      transition: background-color 0.3s;
    }

    .custom-file-upload:hover {
      background-color: #0056b3;
    }

    .status {
      font-family: 'Courier New', monospace;
      font-size: 1.2rem;
      color: #555;
      border-right: 2px solid #555;
      white-space: nowrap;
      overflow: hidden;
      width: 0;
      animation: typing 3s steps(30, end) forwards, blink 0.75s step-end infinite;
      margin: 20px;
    }

    @keyframes typing {
      from { width: 0 }
      to { width: 600px; }
    }

    @keyframes blink {
      50% { border-color: transparent; }
    }

    #canvas {
      position: absolute;
      top: 0;
      left: 0;
      pointer-events: none;
      border-radius: 8px;
    }

    .landmark {
      position: absolute;
      border-radius: 50%;
      width: 8px;
      height: 8px;
      background-color: red;
      transition: all 0.3s ease;
    }

    .landmark:hover {
      background-color: #ffcc00;
      transform: scale(1.5);
    }

    video:fullscreen,
    .video-player-container:fullscreen {
      width: 100vw !important;
      height: 100vh !important;
      object-fit: contain;
      background-color: black;
    }
  </style>
</head>
<body>

  <h2>üé• Hand Gesture Video Control</h2>

  <div class="file-upload-container">
    <input type="file" id="fileInput" class="file-input" accept="video/*">
    <label for="fileInput" class="custom-file-upload btn btn-primary">
      <i class="bi bi-camera-reels"></i> Ch·ªçn video
    </label>
    <a href="{% url 'home' %}" class="btn btn-primary"><i class="bi bi-arrow-return-left"></i> Quay l·∫°i trang ch·ªß</a>
  </div>

  <div class="controls">
    <button id="startCam">üé¨ B·∫≠t Camera</button>
    <button id="stopCam" style="display: none;">üõë T·∫Øt Camera</button>
  </div>

  <div class="container">
    <div class="video-player-container">
      <video id="player" controls width="100%">
        <source id="videoSource" src="/static/video/sample.mp4" type="video/mp4">
        Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ video.
      </video>
    </div>
    <div class="video-container camera-container">
      <video id="video" autoplay muted width="100%"></video>
    </div>
  </div>

  <p id="status" class="status">ƒêang ch·ªù b·∫≠t camera...</p>
  <div id="infoDisplay" style="position:absolute; top:10px; right:10px; color:white; font-weight:bold; background:rgba(0,0,0,0.5); padding:6px 10px; border-radius:8px;">
    üïí 0:00 / 0:00 | üîä 100%
  </div>
  <canvas id="canvas" width="640" height="480"></canvas>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <script>
    const player = document.getElementById('player');
    const videoEl = document.getElementById('video');
    const statusText = document.getElementById('status');
    const startBtn = document.getElementById('startCam');
    const stopBtn = document.getElementById('stopCam');
    const videoInput = document.getElementById('fileInput');
    const videoSource = document.getElementById('videoSource');
    let handsActive = false;
    let camera = null;
    let lastAction = 0;

    videoInput.onchange = (e) => {
      const file = e.target.files[0];
      if (file) {
        const url = URL.createObjectURL(file);
        videoSource.src = url;
        player.load();
      }
    };

    setInterval(() => {
      if (!isNaN(player.duration)) {
        const current = player.currentTime;
        const duration = player.duration;
        const formatTime = (t) => `${Math.floor(t / 60)}:${Math.floor(t % 60).toString().padStart(2, '0')}`;
        const volumePercent = Math.round(player.volume * 100);
        document.getElementById('infoDisplay').innerText = `üïí ${formatTime(current)} / ${formatTime(duration)} | üîä ${volumePercent}%`;
      }
    }, 500);

    function drawLandmarks(landmarks) {
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (!landmarks) return;
      landmarks.forEach((point) => {
        const x = point.x * canvas.width;
        const y = point.y * canvas.height;
        ctx.beginPath(); ctx.arc(x, y, 5, 0, 2 * Math.PI); ctx.fillStyle = 'red'; ctx.fill();
      });
    }

    function enterFullscreen(element) {
      if (element.requestFullscreen) element.requestFullscreen();
      else if (element.webkitRequestFullscreen) element.webkitRequestFullscreen();
      else if (element.msRequestFullscreen) element.msRequestFullscreen();
    }

    function exitFullscreen() {
      if (document.exitFullscreen) document.exitFullscreen();
      else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
      else if (document.msExitFullscreen) document.msExitFullscreen();
    }

    const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
    hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.7, minTrackingConfidence: 0.7 });

    hands.onResults(results => {
      if (!handsActive) return;
      if (results.multiHandLandmarks.length > 0) {
        const hand = results.multiHandLandmarks[0];
        drawLandmarks(hand);
        const tips = [8, 12, 16, 20];  // Ng√≥n tay: 8 - ng√≥n tr·ªè, 12 - ng√≥n gi·ªØa, 16 - ng√≥n √°p √∫t, 20 - ng√≥n √∫t
        let extendedFingers = tips.reduce((acc, i) => acc + (hand[i].y < hand[i - 2].y ? 1 : 0), 0);
    
        const now = Date.now();
        if (now - lastAction > 2000) {
          if (extendedFingers === 4) { 
            player.play();
            statusText.innerText = "‚ñ∂Ô∏è ƒêang ph√°t video (m·ªü tay)";
            statusText.style.color = "green"; 
            lastAction = now;
          }
          else if (extendedFingers === 0) { 
            player.pause();
            statusText.innerText = "‚è∏ ƒê√£ t·∫°m d·ª´ng (n·∫Øm tay)";
            statusText.style.color = "red"; 
            lastAction = now; 
          }
          // B·∫≠t full m√†n h√¨nh khi c√≥ 2 ng√≥n (ng√≥n tr·ªè v√† ng√≥n gi·ªØa)
          else if (extendedFingers === 2) { 
            enterFullscreen(document.querySelector('.video-player-container'));
            statusText.innerText = "üñ• B·∫≠t full m√†n h√¨nh (2 ng√≥n)";
            statusText.style.color = "blue"; 
            lastAction = now;
          }
          // Tho√°t full m√†n h√¨nh khi c√≥ 3 ng√≥n
          else if (extendedFingers === 3) { 
            exitFullscreen();
            statusText.innerText = "‚ùå Tho√°t full m√†n h√¨nh (3 ng√≥n)";
            statusText.style.color = "orange"; 
            lastAction = now;
          }
        }
    
        const thumb = hand[4];
        const index = hand[8];
        const distance = Math.hypot(index.x - thumb.x, index.y - thumb.y);
        const normalized = Math.max(0, Math.min(1, (distance - 0.05) / (0.3 - 0.05)));
        player.volume = normalized;
      } else {
        drawLandmarks(null);
      }
    });
    

    startBtn.onclick = () => {
      videoEl.style.display = "block";
      startBtn.style.display = "none";
      stopBtn.style.display = "inline-block";
      handsActive = true;
      statusText.innerText = "üì∑ ƒêang nh·∫≠n di·ªán tay...";
      camera = new Camera(videoEl, {
        onFrame: async () => await hands.send({ image: videoEl }),
        width: 480, height: 360
      });
      camera.start();
    };

    stopBtn.onclick = () => {
      handsActive = false;
      videoEl.style.display = "none";
      stopBtn.style.display = "none";
      startBtn.style.display = "inline-block";
      statusText.innerText = "üõë Camera ƒë√£ t·∫Øt";
      if (camera) camera.stop();
    };

    let isDragging = false;
    let offsetX, offsetY;
    videoEl.onmousedown = (e) => { isDragging = true; offsetX = e.clientX - videoEl.offsetLeft; offsetY = e.clientY - videoEl.offsetTop; };
    document.onmousemove = (e) => { if (isDragging) { videoEl.style.left = `${e.clientX - offsetX}px`; videoEl.style.top = `${e.clientY - offsetY}px`; } };
    document.onmouseup = () => { isDragging = false; };
  </script>
</body>
</html>
